# Advertising Dashboard Performance & Accuracy Improvements

## 📌 Overview
광고주용 상세 대시보드와 엑셀 다운로드 기능에서 성능 저하와 통계 부정확 문제가 발견되었습니다.  
N+1 쿼리 구조와 중복 카운팅 로직을 분석하여 **성능과 데이터 정확도를 동시에 개선**했습니다.

## 🎯 Goals
- 대용량 조회 시에도 안정적인 응답 속도 확보
- 시청/노출 인구 통계의 중복 집계를 제거하여 신뢰도 향상
- 엑셀 다운로드 대기 시간을 체감 가능한 수준으로 단축

## 🧱 Responsibilities
- 대시보드 API 쿼리 및 서비스 레이어 성능 분석
- 테스트 코드 추가로 기존 로직 출력값 검증
- N+1 쿼리 제거 및 Batch Query 기반 리팩토링
- 시청/노출 인구 중복 제거 알고리즘 설계 및 적용
- Before/After 통계 비교 및 수치 검증

## 🛠 Implementation

### 1) Dashboard Query Optimization
- 광고–차량–시청 로그를 중첩 루프로 순회하며 매번 DB에 접근하던 구조를 분석
- 필요한 데이터를 **한 번에 조회 후 메모리에서 매핑**하는 방식으로 변경
- 통계 계산용 DTO를 정의하여 로직 가독성과 테스트 용이성 향상

### 2) Excel Export Performance
- 동일한 N+1 패턴이 엑셀 다운로드에서도 반복되는 것을 확인
- 대시보드와 동일한 Batch Query 구조로 변경하여 I/O 횟수 감소
- 엑셀 생성 과정에서 불필요한 변환 로직 정리

## 📊 Accuracy Improvements (중복 제거 전/후 비교)

중복 제거 테스트 문서와 실제 대시보드 데이터를 기준으로 아래 수치 개선을 확인했습니다.

- **노출 인구**
  - 기존: 12,660명
  - 개선: 10,737명  
  → 약 **15.2%** 과대 집계 해소

- **시청 인구**
  - 기존: 3,907명
  - 개선: 3,445명  
  → 약 **11.8%** 과대 집계 해소

이 수치는 **raw_observation_data에서 동일 인물이 여러 번 감지되던 문제**를  
Unique population 단위로 다시 계산하여 얻은 결과입니다.

## 🧮 Deduplication Algorithm (High Level)

1. raw_observation_data에서 광고·날짜·개인별 이벤트를 조회
2. 동일 개인이 여러 번 노출/시청되더라도
   - 인구 수 카운트는 `min(1, count)`로 고정
3. 시간 및 조건(예: 1초 이상 시청)을 만족하는 레코드만 유효 시청으로 인정
4. 광고 효과 대시보드, 엑셀 리포트에 동일 로직을 적용

## 📊 Impact / KPI
- ⚡ 대시보드·엑셀 API의 DB 접근 횟수 대폭 감소
- 📉 노출/시청 인구 통계 오차 **10–15% 수준으로 개선**
- 📊 광고주 리포트의 신뢰도 향상
- 🧪 테스트 코드 도입으로 이후 리팩토링 시 회귀 버그 방지
